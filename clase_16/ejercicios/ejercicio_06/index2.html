<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad 6: Visualización de Metadatos (GitHub API)</title>
    <style>
        body { font-family: 'Arial', sans-serif; padding: 30px; background-color: #f8f8f8; color: #333; }
        h1 { color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .metadata-box { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; padding: 15px; margin-bottom: 20px; border-radius: 4px; font-size: 1.1em; }
        .metadata-box p { margin: 5px 0; }
        .metadata-box strong { font-weight: bold; }
        
        .repo-item { background-color: white; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .repo-item h4 { margin-top: 0; color: #343a40; }
        .repo-item small { color: #6c757d; }

        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <h1>Actividad 6: Visualización de Metadatos de API (GitHub)</h1>
    <p>Se utiliza la API de GitHub para buscar repositorios de la organización "google".</p>
    <p>La información de paginación (Next/Last Page) se extrae de los **Headers HTTP**.</p>
    
    <div class="metadata-box" id="metadata-output">
        <p>Cargando metadatos...</p>
    </div>

    <div class="pagination-controls">
        <button id="prev-btn" onclick="fetchPage(prevLink)" disabled>Página Anterior</button>
        <button id="next-btn" onclick="fetchPage(nextLink)" disabled>Página Siguiente</button>
    </div>

    <h2>Resultados de Repositorios</h2>
    <div id="results-list">
        <p>Cargando repositorios...</p>
    </div>

    <script>
        const INITIAL_URL = 'https://api.github.com/search/repositories?q=org:google&per_page=10';
        
        // Variables globales para almacenar los links de paginación (Metadatos)
        let totalCount = 0;
        let nextLink = null;
        let prevLink = null;
        let lastLink = null;

        const metadataOutput = document.getElementById('metadata-output');
        const resultsList = document.getElementById('results-list');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        /**
         * Función para analizar el Header 'Link' de GitHub y extraer URLs de paginación.
         * @param {string} linkHeader - El valor del header Link.
         */
        function parseLinkHeader(linkHeader) {
            nextLink = null;
            prevLink = null;
            lastLink = null;

            if (!linkHeader) return;

            // El header Link tiene este formato: <url>; rel="next", <url>; rel="last"
            linkHeader.split(',').forEach(link => {
                const parts = link.split(';');
                if (parts.length < 2) return;

                const url = parts[0].trim().slice(1, -1); // Extrae la URL
                const rel = parts[1].trim().slice(5, -1); // Extrae el 'rel' (next, prev, last)

                if (rel === 'next') nextLink = url;
                if (rel === 'prev') prevLink = url;
                if (rel === 'last') lastLink = url;
            });
        }

        /**
         * Función principal para realizar la petición y procesar los metadatos.
         * @param {string} url - URL a solicitar.
         */
        async function fetchPage(url = INITIAL_URL) {
            resultsList.innerHTML = '<p>Buscando repositorios...</p>';
            metadataOutput.innerHTML = '<p>Analizando metadatos...</p>';
            prevBtn.disabled = true;
            nextBtn.disabled = true;

            try {
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                // 1. OBTENER METADATOS DEL HEADER 'Link'
                const linkHeader = response.headers.get('Link');
                parseLinkHeader(linkHeader);
                
                // 2. OBTENER METADATOS DEL CUERPO JSON (total_count)
                const data = await response.json();
                totalCount = data.total_count;
                const items = data.items;
                
                // 3. PROCESAR Y MOSTRAR METADATOS EN INTERFAZ
                const currentShowing = items.length;
                let pageNumber = 1;
                if (url.includes('page=')) {
                    // Extraer el número de página de la URL si existe
                    const urlParams = new URLSearchParams(url.split('?')[1]);
                    pageNumber = parseInt(urlParams.get('page')) || 1;
                }
                
                // Si existe lastLink, podemos calcular el total de páginas
                const lastPageNum = lastLink ? new URLSearchParams(lastLink.split('?')[1]).get('page') : '?';

                metadataOutput.innerHTML = `
                    <p><strong>Total de Resultados:</strong> ${totalCount}</p>
                    <p><strong>Mostrando:</strong> ${currentShowing} elementos en la página actual.</p>
                    <p><strong>Paginación:</strong> Página ${pageNumber} de (aprox.) ${lastPageNum}.</p>
                    <p><strong>Metadato 'next_page':</strong> ${nextLink ? 'Sí, haga clic en Siguiente' : 'No'}</p>
                `;

                // 4. ACTUALIZAR CONTROLES DE PAGINACIÓN
                prevBtn.disabled = !prevLink;
                nextBtn.disabled = !nextLink;
                
                // 5. RENDERIZAR RESULTADOS
                renderResults(items);

            } catch (error) {
                resultsList.innerHTML = `<p style="color: red;">Error: ${error.message}.</p>`;
                metadataOutput.innerHTML = `<p style="color: red;">No se pudieron obtener los metadatos.</p>`;
                console.error("Fallo al obtener datos de GitHub:", error);
            }
        }

        function renderResults(repos) {
            if (repos.length === 0) {
                resultsList.innerHTML = '<p>No se encontraron repositorios.</p>';
                return;
            }

            let htmlContent = '';
            repos.forEach(repo => {
                htmlContent += `
                    <div class="repo-item">
                        <h4>${repo.name}</h4>
                        <p>${repo.description || 'Sin descripción'}</p>
                        <small>Stars: ${repo.stargazers_count} | Lenguaje: ${repo.language || 'N/A'}</small>
                    </div>
                `;
            });

            resultsList.innerHTML = htmlContent;
        }

        // Iniciar la búsqueda al cargar la página
        window.onload = () => fetchPage(INITIAL_URL);
    </script>

</body>
</html>